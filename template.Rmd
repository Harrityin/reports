---
title: "大脑学习能力测评"
subtitle: "集体报告"
date: "2017年12月8日"
output:
  word_document:
    toc: true
    fig_caption: true
    reference_docx: docs/word-styles-reference-report.docx
toc-title: "目录"
params:
  user_info:
    label: "学生基本信息:"
    value: data/user_info_test.rds
    input: file
  user_exam:
    label: "学生考试得分:"
    value: data/user_exam_test.rds
    input: file
  user_ability:
    label: "学生能力得分:"
    value: data/user_ability_test.rds
    input: file
  time_tf:
    label: "是否自动获得学生测评时间？"
    value: true
    input: checkbox
  time:
    label: "学生测评时间（取消勾选上一项后请认真填写）:"
    value: !r date()
    input: date
  abilities:
    label: "请选择所有需要报告的能力:"
    value: ["反应力", "注意力", "记忆力", "自控力", "思维力"]
    input: select
    choices: ["反应力", "注意力", "记忆力", "自控力", "思维力"]
    multiple: true
---

```{r load packages and configurations, include=FALSE}
# load packages
library(tidyverse)
library(extrafont)
# parse params
user_info_file <- params$user_info
user_exam_file <- params$user_exam
user_ability_file <- params$user_ability
assess_time_auto <- params$time_tf
assess_time <- params$time
abilities <- params$abilities
# configuration settings
meta_vars <- c("userId", "姓名", "性别", "学校", "年级", "班")
rnk_cutedges_ability <- qnorm(c(0, 0.3, 0.7, 0.9, 1)) * 15 + 100
# all the candidate reported abilities
ability_candidates <- c("反应力", "注意力", "记忆力", "自控力", "思维力")
# get the last modification time of data files
mtimes <- lapply(
  Sys.glob(c(user_info_file, user_exam_file, user_ability_file)),
  function(x) file.info(x)$mtime
)
```

```{r load data, include=FALSE, cache=TRUE, cache.extra=mtimes}
# load user information
user_info <- read_rds(user_info_file)
# load user exam information
user_exam <- read_rds(user_exam_file)
# load user ability score
user_ability <- read_rds(user_ability_file)
# # if not input assess time, use the median of createDate
if (assess_time_auto)
  assess_time <- median(user_ability$createDate)
# do some transformations
schools <- unique(user_info$学校)
```

# 报告说明

---

“大脑学习能力”测评系统（以下简称学习能力测评）由北京师范大学脑与学习科学研究中心与成都爱智游科技有限公司联合编制。“大脑学习能力”测评系统整合了国际国内脑科学研究最新成果，依据脑功能分化和整合原理，以及大脑功能可塑性原理，采用计算机化认知测试的方式，全面测查与个体学习和发展密切相关的“大脑学习能力”。同传统智力测验相比，“大脑学习能力”测评具有科学性强、实施方便、准确度高、预测效度好、可反复测试等优势，代表了当今脑力测试的新趋势。

“大脑学习能力”测评综合考察注意力、记忆力、反应力、自控力等与人脑信息加工、学习、适应和发展密切相关的重要高级功能和大脑学习能力。这些能力覆盖了大脑的核心功能网络，是人脑智慧的集中体现。大量证据表明，个体在这些能力中的表现与其智力，学习能力，社会适应能力和未来发展潜力具有密切关系。

“大脑学习能力”测评提供多种能力维度指标，包含综合的大脑学习能力指数（Brain Learning Ablility Index, BLAI）和各个能力维度指数（注意力指数、记忆力指数、反应力指数、自控力指数）。

# 学生参加测评的情况

---

**测评时间**：`r strftime(assess_time, "%Y年%b") # format as "yyyy年MM月"`

**实测人数[^1]**：`r length(unique(user_ability$userId))`人

```{r count users, echo=FALSE, message=FALSE, warning=FALSE}
user_info %>%
  group_by(学校, 年级) %>%
  summarise(人数 = length(unique(userId))) %>%
  knitr::kable(caption = "各学校各年级实测人数")
```

[^1]: 即实际测得数据中，至少包含所测能力中的一项的学生总数，可能会少于计划参加测评的学生总数。

# 详细报告

---

## 大脑学习能力指数

```{r calculate BLAI, echo=FALSE, message=FALSE, warning=FALSE}
BLAI <- user_ability %>%
  group_by(userId) %>%
  summarise(BLAI = mean(abscore, na.rm = TRUE)) %>%
  mutate(rank = cut(BLAI, rnk_cutedges_ability, LETTERS[4:1])) %>%
  inner_join(user_info)
```

综合能力分数由大脑学习能力指数（BLAI）表示，它反映了注意力、记忆力、自控力、反应力这四方面认知能力的综合水平。

```{r summary statistics for BLAI by grade, echo=FALSE, message=FALSE, warning=FALSE}
BLAI %>%
  group_by(学校, 年级) %>%
  summarise(
    人数 = n(),
    平均分 = mean(BLAI),
    标准差 = sd(BLAI),
    最高分 = max(BLAI),
    最低分 = min(BLAI),
    A = sum(rank == "A"),
    B = sum(rank == "B"),
    C = sum(rank == "C"),
    D = sum(rank == "D")
  ) %>%
  knitr::kable(digits = 2, caption = "BLAI指数简表[^2]")
```

[^2]: A，B，C，D四个等级分别表示优秀（全国同龄水平90%以上），良好（全国同龄水平70%-90%），普通（全国同龄水平30%-70%），不足（全国同年龄水平30%以下）。表中列出了处于各个等级的学生人数。

```{r summary statistics for BLAI by class, echo=FALSE, message=FALSE, warning=FALSE}
BLAI %>%
  group_by(学校, 年级, 班) %>%
  summarise(
    人数 = n(),
    平均分 = mean(BLAI),
    标准差 = sd(BLAI),
    最高分 = max(BLAI),
    最低分 = min(BLAI),
    A = sum(rank == "A"),
    B = sum(rank == "B"),
    C = sum(rank == "C"),
    D = sum(rank == "D")
  ) %>%
  knitr::kable(digits = 2, caption = "各年级各班BLAI指数简表")
```

### 各年级学业成绩与BLAI指数的相关关系

```{r lesson and BLAI, echo=FALSE, message=FALSE, warning=FALSE, fig.cap=fig_captions}
fig_captions <- paste0(schools, "学生学业成绩和BLAI指数的相关关系")
BLAI_exam <- user_exam %>%
  inner_join(BLAI)
for (school in schools){
  schoolplot <- BLAI_exam %>%
    filter(学校 == school) %>%
    ggplot(aes(BLAI, 成绩, color = 学科)) +
    geom_point() +
    stat_smooth(method = "glm") +
    facet_wrap(~年级, scales = "free") +
    theme_minimal() +
    labs(
      title = paste0("BLAI与学业成绩的关系"),
      x = "BLAI指数",
      y = "学业成绩"
    ) +
    theme(
      title = element_text(family = "SimHei"),
      plot.title = element_text(hjust = 0.5)
    )
  # render the plot
  print(schoolplot)
  # in order that the captions would render
  cat("\n\n")
}
```

```{r ATTENTION preamble, include=FALSE}
ability_name <- "注意力"
fig_captions <- paste0(schools, "学生学业成绩和", ability_name, "指数的相关关系")
```

```{r ATTENTION header, echo=FALSE, warning=FALSE, message=FALSE, results='asis', eval=ability_name %in% abilities, fig.cap=fig_captions}
# header message
cat("
## 注意力指数

注意是大脑接收和处理个体外部和内部信息的前提，只有被注意到的信息才能得到有效的分析和处理，并用来解决问题并形成持久的记忆。
")
# data extract
ability_data <- user_ability %>%
  filter(abname == ability_name) %>%
  mutate(rank = cut(abscore, rnk_cutedges_ability, LETTERS[4:1])) %>%
  inner_join(user_info)
# score statistics by grade
ability_data %>%
  group_by(学校, 年级) %>%
  summarise(
    人数 = n(),
    平均分 = mean(abscore),
    标准差 = sd(abscore),
    最高分 = max(abscore),
    最低分 = min(abscore),
    A = sum(rank == "A"),
    B = sum(rank == "B"),
    C = sum(rank == "C"),
    D = sum(rank == "D")
  ) %>%
  knitr::kable(digits = 2,
               caption = paste0(ability_name, "得分简表"))
# score statistics by class
ability_data %>% 
  group_by(学校, 年级, 班) %>% 
  summarise(
    人数 = n(),
    平均分 = mean(abscore),
    标准差 = sd(abscore),
    最高分 = max(abscore),
    最低分 = min(abscore),
    A = sum(rank == "A"),
    B = sum(rank == "B"),
    C = sum(rank == "C"),
    D = sum(rank == "D")
  ) %>%
  knitr::kable(digits = 2, 
               caption = paste0("各年级各班", ability_name, "得分简表"))
# figure header
cat(paste0("### 各年级学业成绩与", ability_name, "的相关关系\n\n"))
ability_exam <- user_exam %>%
  inner_join(ability_data)
for (school in schools){
  schoolplot <- ability_exam %>%
    filter(学校 == school) %>%
    ggplot(aes(abscore, 成绩, color = 学科)) +
    geom_point() +
    stat_smooth(method = "glm") +
    facet_wrap(~年级, scales = "free") +
    theme_minimal() +
    labs(
      title = paste0(ability_name, "与学业成绩的关系"),
      x = paste0(ability_name, "得分"),
      y = "学业成绩"
    ) +
    theme(
      title = element_text(family = "SimHei"),
      plot.title = element_text(hjust = 0.5)
    )
  # render the plot
  print(schoolplot)
  # in order that the captions would render
  cat("\n\n")
}
```
