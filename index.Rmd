---
title: "大脑学习能力测评"
subtitle: "学校集体报告"
date: "`r format(Sys.time(), '%Y年%b%e日')`"
toc-title: "目录"
params:
  ability_scores_file:
    label: "学生能力得分："
    value: data/daxing/ability_scores.xlsx
    input: file
  school_name:
    label: "学校名称："
    value: 北京市大兴区兴华中学
    input: text
  test_date_auto:
    label: "是否自动获得学生测评时间？"
    value: true
    input: checkbox
  test_date:
    label: "学生测评时间（取消勾选上一项后请认真填写）："
    value: !r date()
    input: date
---

```{r configs, include=FALSE}
# load packages
library(tidyverse)
library(readxl)
# TODO(Liang Zhang): find a proper way to solve the font issues
library(extrafont)
font_import(prompt = FALSE, pattern = "NotoSansCJKtc-Light")

# parse params
ability_scores_file <- params$ability_scores_file
school_name <- params$school_name
test_date_auto <- params$test_date_auto
test_date <- params$test_date

# load ability scores
ability_scores_district <- read_excel(ability_scores_file)
# filter out scores for current school
if (!school_name %in% ability_scores_district$school) stop("School not found!")
ability_scores_school <- ability_scores_district %>%
  filter(school == school_name)
# get classes
school_classes <- unique(ability_scores_school$cls)
# set test date
if (test_date_auto) {
  test_date <- median(ability_scores_school$createTime)
}

# user-defined functions
#' Summarise function used for summary table generation
#'
#' @params raw_tab Raw data table as a data.frame
#' @params reg_type The region type as a character/character vector
#' @params ab_type The ability type as a character, i.e., the name of ability
#' @return The summarised table
sum_tab <- function(raw_tab, reg_type, ab_type) {
  out_tab <- raw_tab %>%
    add_column(type = reg_type) %>%
    group_by(type) %>%
    filter(ability == ab_type) %>%
    summarise(
      实测人数 = n(),
      平均分 = mean(score, na.rm = TRUE),
      标准差 = sd(score, na.rm = TRUE),
      最高分 = max(score, na.rm = TRUE),
      最低分 = min(score, na.rm = TRUE),
      A = sum(level == "A", na.rm = TRUE),
      B = sum(level == "B", na.rm = TRUE),
      C = sum(level == "C", na.rm = TRUE),
      D = sum(level == "D", na.rm = TRUE)
    ) %>%
    ungroup()
  return(out_tab)
}
```

# 报告说明

<!-- 使用没有序号的格式 -->
## 项目背景介绍

<!-- 本次测试基于什么背景下进行实施 （可以跟协同中心要 -->
<!-- 共施测多少个学校，多少学生 -->

<!-- 使用没有序号的格式 -->
## “大脑学习能力”测评系统介绍

“大脑学习能力”测评系统（以下简称学习能力测评）由北京师范大学脑与学习科学研究中心编制。“大脑学习能力”测评系统整合了国际国内脑科学研究最新成果，依据脑功能分化和整合原理，以及大脑功能可塑性原理，采用计算机化认知测试的方式，全面测查与个体学习和发展密切相关的“大脑学习能力”。同传统智力测验相比，“大脑学习能力”测评具有科学性强、实施方便、准确度高、预测效度好、可反复测试等优势，代表了当今脑力测试的新趋势。

“大脑学习能力”测评综合考察注意力、记忆力、反应力、自控力等与人脑信息加工、学习、适应和发展密切相关的重要高级功能和大脑学习能力。这些能力覆盖了大脑的核心功能网络，是人脑智慧的集中体现。大量证据表明，个体在这些能力中的表现与其智力，学习能力，社会适应能力和未来发展潜力具有密切关系。同时，我们还重点考察了数学学科基础能力，以测试学生的数学能力发展情况。

<!-- 使用没有序号的格式 -->
## 学生参加测评的情况

* 测评学校：`r school_name`
* 测评时间：`r format(test_date, "%Y年%b")`
* 实测人数：`r n_distinct(ability_scores_school$userId)`人

# 详细报告

## 大脑学习能力指数（BLAI）

```{r blai-config, include=FALSE}
ab_type <- "学习能力指数"
```

<!-- 本校和本区的BLAI指数分布对比 -->
```{r blai-histogram, echo=FALSE, warning=FALSE, message=FALSE}
list(本区 = ability_scores_district, 本校 = ability_scores_school) %>%
  bind_rows(.id = "type") %>%
  filter(ability == ab_type) %>%
  ggplot(aes(score, fill = type)) +
  geom_density(color = NA, alpha = 0.5) +
  theme_minimal() +
  theme(
    text = element_text(family = "Noto Sans CJK TC Light"),
    panel.grid = element_blank()
  )
```

<!-- 本区、本校和本校各班的描述性统计表 -->
```{r blai-tab, echo=FALSE, warning=FALSE, message=FALSE}
summary_district <- ability_scores_district %>%
  sum_tab("本区", ab_type)
summary_school <- ability_scores_school %>%
  sum_tab("本校", ab_type)
summary_school_class <- ability_scores_school %>%
  sum_tab(paste0(.$cls, "班"), ab_type)
list(summary_district, summary_school, summary_school_class) %>%
  reduce(rbind) %>%
  rename(` ` = type) %>%
  knitr::kable(digits = 2)
```

```{r blai-data-preparation, include=FALSE}
plot_dataset <- list(本区 = ability_scores_district, 本校 = ability_scores_school, 各班 = ability_scores_school) %>%
  bind_rows(.id = "type") %>%
  filter(ability == ab_type) %>%
  mutate(cls = if_else(type != "各班", NA_character_, cls))
bp_stats <- boxplot.stats(plot_dataset$score)
```

<!-- 本区、本校和本校各班的箱型图 -->
```{r blai-boxplot, echo=FALSE, warning=FALSE, message=FALSE, out.height=}
list(本区 = ability_scores_district, 本校 = ability_scores_school, 各班 = ability_scores_school) %>%
  bind_rows(.id = "type") %>%
  filter(ability == ab_type) %>%
  mutate(cls = if_else(type != "各班", NA_character_, cls)) %>%
  ggplot(aes(type, score, fill = cls)) +
  geom_boxplot(size = 1, outlier.color = NA, width = 0.5) +
  scale_x_discrete(limits = c("各班", "本校", "本区")) +
  scale_y_continuous(limits = bp_stats$stats[c(1, 5)], position = "right") +
  scale_fill_brewer(breaks = school_classes, palette = "Pastel1") +
  labs(x = "", y = "分数", fill = "") +
  coord_flip() +
  theme_minimal() +
  theme(
    text = element_text(family = "Noto Sans CJK TC Light"),
    plot.margin = margin(0.05, 0.05, 0.05, 0.05, unit = "npc"),
    panel.grid.major.x = element_line(linetype = "dotted", color = "black"),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    legend.text = element_text(size = 12),
    axis.text = element_text(size = 12),
    axis.title.x.top = element_text(face = "bold", size = 18, margin = margin(b = 0.8, unit = "npc"))
  )
```

<!-- 本区、本校和本校各班学生各个水平上的人数比例 -->
```{r blai-grading, echo=FALSE}

```

第二部分 注意力指数

第三部分 反应力指数

第四部分 记忆力指数

第五部分 自控力指数

第六部分 思维力指数

第七部分 数学学科基础能力


未来发展建议
大兴区发展情况建议
1、	区域需要重视基础能力建设（罗列一些文献以及政策）；
2、	增设相关课程（必修课程）；
本校发展情况建议
1、	根据学生的整体表现情况，对各个分量表的发展提出建议；
2、	动员学生家长参与到教育中，重视基础能力教育；
3、	未来开设相关课程，增加纵向研究数据
